<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Log In</title>
    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            --primary-color: #0078d7; /* Default blue */
            --secondary-color: #00c6fb; /* Default cyan */
            --text-color: #333; /* Default dark text */
            --text-light: #fff; /* Light text color */
            --bg-light-gradient: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            --container-bg: #fff; /* Default white container background */
            --container-shadow: 0 8px 32px 0 rgba(31,38,135,0.18);
            --container-border: 1px solid rgba(255,255,255,0.18);
            --button-primary-bg: var(--primary-color);
            --button-primary-text: #fff;
            --input-bg: #fff;
            --input-border: #ccc;
            --list-item-bg: linear-gradient(90deg, #e3f0fc 0%, #f2fcfe 100%);
            --list-item-hover-bg: linear-gradient(90deg, #00c6fb22 0%, #0078d722 100%);
            --header-bg: linear-gradient(90deg, #0078d7 0%, #00c6fb 100%);
        }

        /* --- Dark Mode Theme --- */
        .theme-dark {
            --primary-color: #00c6fb; /* Brighter blue/cyan for accents */
            --secondary-color: #0078d7; /* Darker blue */
            --text-color: #e0e0e0; /* Light gray text */
            --text-light: #fff; /* White text for headers/buttons */
            --bg-light-gradient: linear-gradient(135deg, #1a202c 0%, #2d3748 100%); /* Dark background gradient */
            --container-bg: #2d3748; /* Dark gray background for containers */
            --container-shadow: 0 8px 32px 0 rgba(0,0,0,0.4);
            --container-border: 1px solid rgba(255,255,255,0.1);
            --button-primary-bg: #00c6fb; /* Accent for buttons */
            --button-primary-text: #000; /* Black text on accent button */
            --input-bg: #4a5568; /* Darker input background */
            --input-border: #718096;
            --list-item-bg: linear-gradient(90deg, #2d3748 0%, #374151 100%);
            --list-item-hover-bg: linear-gradient(90deg, #4a556822 0%, #5a677d22 100%);
            --header-bg: linear-gradient(90deg, #1a202c 0%, #2d3748 100%); /* Darker header gradient */
        }

        /* --- General Styles --- */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            height: 100vh;
            align-items: center;
            justify-content: center;
            background: var(--bg-light-gradient);
            min-height: 100vh;
            color: var(--text-color);
            transition: background 0.3s ease;
        }
        .login-container, .dashboard-container, .logs-container, #usersContainer, #chatContainer, #reportContainer, #settingsContainer { /* Ensure all containers respect variables */
            background: var(--container-bg);
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: var(--container-shadow);
            border: var(--container-border);
            width: 320px;
            color: var(--text-color);
            transition: background 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .login-container h2, .dashboard-container h2, .logs-container h2 {
            margin-bottom: 20px;
            text-align: center;
            color: var(--text-color);
        }
        .login-container input[type="text"],
        .login-container input[type="password"],
        #signupForm input[type="text"], #signupForm input[type="password"],
        #settingsForm input, /* General for settings inputs */
        #chatInput {
            width: 100%;
            padding: 10px;
            margin: 8px 0 16px 0;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--text-color);
            box-sizing: border-box; /* Important for layout */
        }
        .login-container button, .dashboard-container button, .logs-container button, .back-btn, #saveSettingsBtn, #updatePasswordBtn, #signupForm button {
            width: 100%;
            padding: 10px;
            background: var(--button-primary-bg);
            color: var(--button-primary-text);
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        .login-container button:hover, .dashboard-container button:hover, .logs-container button:hover, .back-btn:hover, #saveSettingsBtn:hover, #updatePasswordBtn:hover, #signupForm button:hover {
            filter: brightness(1.1);
        }
        .login-container .error {
            color: #d8000c;
            margin-bottom: 10px;
            text-align: center;
            background-color: #ffebeb;
            border: 1px solid #d8000c;
            padding: 5px;
            border-radius: 4px;
        }
        .login-container .success {
            color: #4BB543;
            margin-bottom: 10px;
            text-align: center;
            background-color: #ebffe0;
            border: 1px solid #4BB543;
            padding: 5px;
            border-radius: 4px;
        }
        /* Refined error styling with icon */
        #message div.error {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #d8000c;
            background: #ffebeb;
            border: 1px solid #d8000c;
        }

        /* --- Notification Toggle Styles --- */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
            vertical-align: middle;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(18px); }
        /* Align the label for the switch properly */
        .switch-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        /* --- Dashboard Specific Styles --- */
        .dashboard-container {
            background: var(--container-bg);
            box-shadow: var(--container-shadow);
            border-radius: 18px;
            border: var(--container-border);
            position: relative;
            overflow: hidden;
        }
        .dashboard-container:before, .dashboard-container:after {
            content: "";
            position: absolute;
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, var(--secondary-color) 50%, transparent 80%);
            z-index: 0;
        }
        .dashboard-container:before { top: -40px; left: -40px; }
        .dashboard-container:after { bottom: -40px; right: -40px; background: radial-gradient(circle, var(--primary-color) 50%, transparent 80%); }
        .dashboard-container * { position: relative; z-index: 1; }
        .dashboard-header {
            background: var(--header-bg); /* Themed header */
            color: var(--text-light);
            border-radius: 8px;
            margin-bottom: 18px;
            padding: 12px 0;
            box-shadow: 0 2px 8px rgba(0,120,215,0.10);
            display: flex; /* Make sure display is set here for template literal */
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .dashboard-header span { /* User/Rank span color */
            color: var(--text-light);
        }
        .dashboard-container ul li {
            background: var(--list-item-bg);
            transition: background 0.3s, transform 0.2s;
            box-shadow: 0 1px 4px rgba(0,120,215,0.06);
            color: var(--text-color); /* Themed text for list items */
        }
        .dashboard-container ul li:hover {
            background: var(--list-item-hover-bg);
            transform: translateY(-2px) scale(1.03);
        }
        .dashboard-container .logout-btn {
            background: linear-gradient(90deg, #d8000c 0%, #ff416c 100%); /* Keep distinct logout style */
            color: #fff;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(216,0,12,0.10);
        }

        /* --- Settings Container Specific Styles --- */
        #settingsForm div { /* Container for each setting group */
            margin-bottom: 15px;
        }
        #settingsForm label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
        }
        #settingsForm select, #settingsForm input[type="text"]:read-only, #settingsForm input[type="password"] {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
        }
        #settingsForm input:focus, #settingsForm select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 120, 215, 0.3); /* Use primary color for focus */
        }
        #changePasswordUsername { /* Read-only password field */
            background-color: #e9ecef !important; /* Keep this subtle grey */
            cursor: not-allowed !important;
            opacity: 0.7;
        }
        #passwordMessage {
            font-size: 14px;
        }

        /* --- Chat Container Theming --- */
        #chatContainer h2 span { /* Chat title color */
            color: var(--text-color);
        }
        #chatMessages {
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
        }
        #chatMessages div { /* Individual message */
            margin-bottom: 8px;
        }
        #chatMessages .font-weight-bold { /* User name color in chat */
            font-weight: bold;
            color: var(--primary-color); /* Accent for user name */
        }
        #chatMessages .color-muted { /* Time stamp color */
            color: #aaa;
            font-size: 12px;
            margin-left: 6px;
        }

        /* --- Logs Container Theming --- */
        .logs-container li {
            background: var(--list-item-bg);
            color: var(--text-color);
        }

        /* --- View Users Container Styling (if specific needed) --- */
        #usersContainer h2 span { /* User view title color */
            color: var(--text-color);
        }
        #usersContainer ul li {
            color: var(--text-color); /* Text color for user list items */
        }


    </style>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div id="message"></div>
        <form id="loginForm">
            <!-- Login Title will be inserted here by JS -->
            <input type="text" id="username" placeholder="Username" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit">Log In</button>
        </form>
    </div>

    <!-- Dashboard Screen -->
    <div class="dashboard-container" id="dashboardContainer" style="display:none;">
        <!-- Dashboard Header will be inserted here by JS -->
        <h2>Admin Dashboard</h2>
        <ul>
            <li>View Users</li>
            <li>Manage Settings</li>
            <li>Reports</li>
            <li id="systemLogsBtn">System Logs</li>
        </ul>
        <button class="logout-btn" id="logoutBtn">Log Out</button>
    </div>

    <!-- System Logs Screen -->
    <div class="logs-container" id="logsContainer" style="display:none;">
        <h2>System Logs</h2>
        <ul id="logsList"></ul>
        <button class="back-btn" id="backToDashboardBtn">Back to Dashboard</button>
    </div>

    <!-- Reports Screen -->
    <div class="logs-container" id="reportContainer" style="display:none;">
        <h2>Reports</h2>
        <ul>
            <li>Monthly Usage: 1200 pages printed</li>
            <li>Top User: ADMIN</li>
            <li>Last Error: None</li>
            <li>System Uptime: 99.9%</li>
        </ul>
        <button class="back-btn" id="backToDashboardFromReportBtn">Back to Dashboard</button>
    </div>

    <!-- Settings Screen -->
    <div class="logs-container" id="settingsContainer" style="display:none;">
        <h2>Settings</h2>
        <form id="settingsForm">
            <div style="margin-bottom: 15px;">
                <label for="themeSelector">Appearance Theme</label>
                <select id="themeSelector" required>
                    <!-- Options populated by JS -->
                </select>
            </div>

            <div style="margin-bottom: 15px;">
                <div class="switch-label">
                    <label for="notificationToggle">Enable Notifications</label>
                    <label class="switch">
                        <input type="checkbox" id="notificationToggle">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <label for="changePasswordUsername">Change Password</label>
                <input type="text" id="changePasswordUsername" placeholder="Current Username" readonly>
                <input type="password" id="oldPassword" placeholder="Old Password">
                <input type="password" id="newPassword" placeholder="New Password">
                <button type="button" id="updatePasswordBtn">Update Password</button>
                <div id="passwordMessage"></div>
            </div>

            <button type="submit" id="saveSettingsBtn">Save Settings</button>
        </form>
        <div id="settingsMessage"></div>
        <button class="back-btn" id="backToDashboardFromSettingsBtn">Back to Dashboard</button>
    </div>

    <!-- Chat System Container -->
    <div class="logs-container" id="chatContainer" style="display:none;">
        <h2>Admin Chat</h2>
        <div id="chatMessages"></div>
        <form id="chatForm">
            <input type="text" id="chatInput" placeholder="Type a message..." required>
            <button type="submit">Send</button>
        </form>
        <button class="back-btn" id="backToDashboardFromChatBtn">Back to Dashboard</button>
    </div>

    <!-- SVG definitions if needed -->
    <svg width="0" height="0" style="position:absolute;">
        <defs>
            <linearGradient id="logsShieldGrad" x1="0" y1="0" x2="54" y2="54" gradientUnits="userSpaceOnUse">
                <stop stop-color="#0078d7"/>
                <stop offset="1" stop-color="#00c6fb"/>
            </linearGradient>
            <linearGradient id="shieldGrad" x1="0" y1="0" x2="54" y2="54" gradientUnits="userSpaceOnUse">
                <stop stop-color="#0078d7"/>
                <stop offset="1" stop-color="#00c6fb"/>
            </linearGradient>
            <linearGradient id="usersGrad" x1="0" y1="0" x2="54" y2="54" gradientUnits="userSpaceOnUse">
                <stop stop-color="#0078d7"/>
                <stop offset="1" stop-color="#00c6fb"/>
            </linearGradient>
        </defs>
    </svg>

    <script>
    // Shared variable for current user
    let currentUser = '';
    // Global DOM element variables for dashboard header
    let usernameSpan;
    let rankSpan;

    // DOM elements - initialize or access from above
    const loginForm = document.getElementById('loginForm');
    const messageDiv = document.getElementById('message');
    const loginContainer = document.getElementById('loginContainer');
    const dashboardContainer = document.getElementById('dashboardContainer');
    const logoutBtn = document.getElementById('logoutBtn');
    const systemLogsBtn = document.getElementById('systemLogsBtn');
    const logsContainer = document.getElementById('logsContainer');
    const backToDashboardBtn = document.getElementById('backToDashboardBtn');
    const reportContainer = document.getElementById('reportContainer');
    const backToDashboardFromReportBtn = document.getElementById('backToDashboardFromReportBtn');
    const settingsContainer = document.getElementById('settingsContainer');
    const backToDashboardFromSettingsBtn = document.getElementById('backToDashboardFromSettingsBtn');
    const settingsForm = document.getElementById('settingsForm');
    const settingsMessage = document.getElementById('settingsMessage');
    const passwordMessage = document.getElementById('passwordMessage');

    // Settings elements
    const themeSelector = document.getElementById('themeSelector');
    const notificationToggle = document.getElementById('notificationToggle');
    const updatePasswordBtn = document.getElementById('updatePasswordBtn');
    const oldPasswordInput = document.getElementById('oldPassword');
    const newPasswordInput = document.getElementById('newPassword');
    const changePasswordUsernameInput = document.getElementById('changePasswordUsername');

    // Dashboard menu items references
    const reportsMenuItem = dashboardContainer.querySelector('li:nth-child(3)');
    const settingsMenuItem = dashboardContainer.querySelector('li:nth-child(2)');


    // --- Theme and Settings Management ---

    const THEMES = {
        default: 'Default (Blue/Cyan)',
        dark: 'Dark Mode'
    };

    // Function to apply theme by adding class to body
    function applyTheme(themeName) {
        // Remove any existing theme classes
        document.body.classList.forEach(className => {
            if (className.startsWith('theme-')) {
                document.body.classList.remove(className);
            }
        });
        // Add the new theme class if it exists
        if (themeName && THEMES[themeName]) {
            document.body.classList.add(`theme-${themeName}`);
        } else if (!themeName) {
             document.body.classList.add('theme-default'); // Ensure a default is applied
        }
    }

    // Function to save settings to localStorage
    function saveSettings() {
        const settings = {
            theme: themeSelector.value,
            notifications: notificationToggle.checked
        };
        localStorage.setItem('adminDashboardSettings', JSON.stringify(settings));
        applyTheme(settings.theme); // Apply theme immediately
        settingsMessage.textContent = 'Settings saved successfully.';
        settingsMessage.style.color = '#4BB543';
        setTimeout(() => { settingsMessage.textContent = ''; }, 3000);
    }

    // Function to load settings from localStorage
    function loadSettings() {
        const savedSettings = localStorage.getItem('adminDashboardSettings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            themeSelector.value = settings.theme || 'default';
            notificationToggle.checked = settings.notifications === true;
            applyTheme(settings.theme);
        } else {
            // Set defaults and apply
            themeSelector.value = 'default';
            notificationToggle.checked = false;
            applyTheme('default');
        }
        // Set the current username to the read-only input in settings
        if (currentUser) {
            changePasswordUsernameInput.value = currentUser;
        } else {
             changePasswordUsernameInput.value = ''; // Clear if no user logged in
        }
    }

    // --- Event Listeners for Settings ---

    // Settings Form Submit
    settingsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        saveSettings();
    });

    // Theme Selector Change (preview or prepare for save)
    themeSelector.addEventListener('change', function() {
        const previewTheme = this.value;
        applyTheme(previewTheme); // Apply visually
        settingsMessage.textContent = 'Theme preview active. Click "Save Settings" to confirm.';
        settingsMessage.style.color = '#ffa500'; // Orange color for pending change
    });

    // Notification Toggle Change (save immediately or wait for general save)
    // For immediate feedback:
    notificationToggle.addEventListener('change', function() {
        let currentSettings = JSON.parse(localStorage.getItem('adminDashboardSettings') || '{}');
        currentSettings.notifications = this.checked;
        localStorage.setItem('adminDashboardSettings', JSON.stringify(currentSettings));
        // No message needed, visual feedback is sufficient
    });

    // --- Password Change Functionality ---
    updatePasswordBtn.addEventListener('click', function() {
        const currentUsername = changePasswordUsernameInput.value;
        const oldPassword = oldPasswordInput.value;
        const newPassword = newPasswordInput.value;
        passwordMessage.textContent = ''; // Clear previous message

        if (!currentUsername || !oldPassword || !newPassword) {
            passwordMessage.textContent = 'Please fill in all password fields.';
            passwordMessage.style.color = '#d8000c';
            return;
        }

        let users = JSON.parse(localStorage.getItem('users') || '{}');

        if (users[currentUsername] !== oldPassword) {
            passwordMessage.textContent = 'Incorrect current password.';
            passwordMessage.style.color = '#d8000c';
            return;
        }

        // In a real application, add password strength validation here.
        users[currentUsername] = newPassword; // Update password
        localStorage.setItem('users', JSON.stringify(users));

        passwordMessage.textContent = 'Password updated successfully!';
        passwordMessage.style.color = '#4BB543';

        // Clear inputs after successful update
        oldPasswordInput.value = '';
        newPasswordInput.value = '';

        // Log the action
        addSystemLog(`User ${currentUsername} changed their password.`);

        // Clear message after a few seconds
        setTimeout(() => { passwordMessage.textContent = ''; }, 3000);
    });

    // --- Helper Function for System Logs ---
    function addSystemLog(message) {
        let logs = JSON.parse(localStorage.getItem('systemLogs') || '[]');
        const now = new Date();
        const timestamp = now.toISOString().replace('T', ' ').substring(0, 19);
        logs.push(`[${timestamp}] ${message}`);
        // Optional: limit log size
        if (logs.length > 100) logs = logs.slice(logs.length - 100);
        localStorage.setItem('systemLogs', JSON.stringify(logs));
    }

    // --- Helper Function to render System Logs ---
    function renderSystemLogs() {
        const logsList = document.getElementById('logsList');
        logsList.innerHTML = '';
        let logs = JSON.parse(localStorage.getItem('systemLogs') || '[]');
        if (logs.length === 0) {
            logsList.innerHTML = '<li style="text-align:center;color:#888;">No logs available.</li>';
        } else {
            // Displaying logs in order of entry (oldest first if added sequentially)
            // You could reverse() logs if you prefer most recent first.
            logs.forEach(function(log) {
                // Sanitize log entry to prevent HTML injection
                const sanitizedLog = log.replace(/</g, "<").replace(/>/g, ">");
                logsList.innerHTML += `<li>${sanitizedLog}</li>`;
            });
        }
        // Ensure scrolling to top on render
        logsList.scrollTop = 0;
    }

    // --- DOM Content Loaded and Initial Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        // Create and insert Login Title with SVG
        let loginTitleDiv = document.getElementById('loginTitleDiv');
        if (!loginTitleDiv) { // Create only if it doesn't exist
            loginTitleDiv = document.createElement('div');
            loginTitleDiv.id = 'loginTitleDiv';
            loginTitleDiv.style.display = 'flex';
            loginTitleDiv.style.flexDirection = 'column';
            loginTitleDiv.style.alignItems = 'center';
            loginTitleDiv.style.marginBottom = '24px';
            loginTitleDiv.innerHTML = `
                <svg width="54" height="54" viewBox="0 0 54 54" fill="none" style="margin-bottom:10px;">
                    <defs>
                        <linearGradient id="shieldGrad" x1="0" y1="0" x2="54" y2="54" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#0078d7"/> <stop offset="1" stop-color="#00c6fb"/>
                        </linearGradient>
                    </defs>
                    <path d="M27 6L46 13V26C46 38 27 48 27 48C27 48 8 38 8 26V13L27 6Z" fill="url(#shieldGrad)" stroke="#0078d7" stroke-width="2"/>
                    <path d="M19 18L22 14L27 20L32 14L35 18" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="27" cy="29" r="6" fill="#fff" stroke="#0078d7" stroke-width="2"/>
                    <path d="M24 29c0-1.7 1.3-3 3-3s3 1.3 3 3-1.3 3-3 3-3-1.3-3-3z" fill="#00c6fb"/>
                </svg>
                <div style="font-size:1.7rem;font-weight:bold;color:#0078d7;letter-spacing:1px;text-shadow:0 2px 8px #00c6fb44;">
                    Admin System Dashboard
                </div>
            `;
            loginContainer.insertBefore(loginTitleDiv, loginContainer.firstChild);
        }
        // Update title colors if a theme is already active
        const currentThemeClass = Array.from(document.body.classList).find(cls => cls.startsWith('theme-'));
        if (currentThemeClass) {
            const titleDiv = document.getElementById('loginTitleDiv');
            if (titleDiv) {
                 const titleSpan = titleDiv.querySelector('div');
                 if(titleSpan) {
                     // Styling will be applied by CSS variables on body, so this might not be strictly needed.
                 }
            }
        }


        // Create and insert Dashboard Header with User Info
        let dashboardHeader = document.getElementById('dashboardHeader');
        if (!dashboardHeader) {
            dashboardHeader = document.createElement('div');
            dashboardHeader.className = 'dashboard-header';
            dashboardHeader.id = 'dashboardHeader';
            dashboardHeader.innerHTML = `
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="8" r="4" fill="#0078d7"/>
                    <path d="M4 20c0-3.3 2.7-6 6-6h4c3.3 0 6 2.7 6 6" fill="#0078d7" opacity="0.2"/>
                    <circle cx="12" cy="8" r="4" fill="none" stroke="#0078d7" stroke-width="2"/>
                    <path d="M4 20c0-3.3 2.7-6 6-6h4c3.3 0 6 2.7 6 6" fill="none" stroke="#0078d7" stroke-width="2"/>
                </svg>
                <span id="dashboardUsername"></span>
                <span id="dashboardRank"></span>
            `;
            dashboardContainer.insertBefore(dashboardHeader, dashboardContainer.firstChild);
        }
        usernameSpan = document.getElementById('dashboardUsername');
        rankSpan = document.getElementById('dashboardRank');

        // Populate the theme selector dropdown
        Object.keys(THEMES).forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = THEMES[key];
            themeSelector.appendChild(option);
        });

        // Load settings upon page load
        loadSettings();

        // --- Navigation Event Listeners ---

        // Login Form Submission
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            messageDiv.innerHTML = ''; // Clear previous messages

            // Simulate loading
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'signinLoadingOverlay'; // Re-use original ID
            loadingOverlay.style.position = 'fixed';
            loadingOverlay.style.top = 0; loadingOverlay.style.left = 0;
            loadingOverlay.style.width = '100vw'; loadingOverlay.style.height = '100vh';
            loadingOverlay.style.background = 'rgba(255,255,255,0.8)';
            loadingOverlay.style.display = 'flex';
            loadingOverlay.style.flexDirection = 'column';
            loadingOverlay.style.alignItems = 'center';
            loadingOverlay.style.justifyContent = 'center';
            loadingOverlay.style.zIndex = 9999;
            loadingOverlay.innerHTML = `
                <div class="spinner"></div>
                <div class="loading-msg">Please wait to log in...</div>
            `;
            document.body.appendChild(loadingOverlay);

            setTimeout(function() {
                document.body.removeChild(loadingOverlay);
                let users = JSON.parse(localStorage.getItem('users') || '{}');
                let isAuthenticated = false;

                if (username === 'ADMIN' && password === 'print1234') {
                    isAuthenticated = true;
                    currentUser = 'ADMIN';
                } else if (users[username] && users[username] === password) {
                    isAuthenticated = true;
                    currentUser = username;
                }

                if (isAuthenticated) {
                    loginContainer.style.display = 'none';
                    dashboardContainer.style.display = 'block';
                    usernameSpan.textContent = currentUser;
                    rankSpan.style.display = (currentUser === 'ADMIN') ? 'inline-block' : 'none'; // Show 'OWNER' for admin
                    rankSpan.textContent = (currentUser === 'ADMIN') ? '(OWNER)' : '';

                    addSystemLog(`User ${currentUser} logged in.`);
                } else {
                    messageDiv.innerHTML = '<div class="error">Invalid account name or password.</div>';
                }
            }, 1500);
        });

        // Logout Button Listener
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const loadingOverlay = document.createElement('div'); // Create new overlay for logout
            loadingOverlay.style.position = 'fixed';
            loadingOverlay.style.top = 0; loadingOverlay.style.left = 0;
            loadingOverlay.style.width = '100vw'; loadingOverlay.style.height = '100vh';
            loadingOverlay.style.background = 'rgba(255,255,255,0.8)';
            loadingOverlay.style.display = 'flex';
            loadingOverlay.style.flexDirection = 'column';
            loadingOverlay.style.alignItems = 'center';
            loadingOverlay.style.justifyContent = 'center';
            loadingOverlay.style.zIndex = 9999;
            loadingOverlay.innerHTML = `
                <div class="spinner"></div>
                <div class="loading-msg">Please wait to log out account...</div>
            `;
            document.body.appendChild(loadingOverlay);

            setTimeout(function() {
                if (currentUser) addSystemLog(`User ${currentUser} logged out.`);
                document.body.removeChild(loadingOverlay);
                loginContainer.style.display = 'block';
                dashboardContainer.style.display = 'none';
                loginForm.reset();
                messageDiv.innerHTML = '';
                currentUser = '';
                if(usernameSpan) usernameSpan.textContent = '';
                if(rankSpan) rankSpan.style.display = 'none';
            }, 1500);
        });

        // System Logs Navigation
        systemLogsBtn.addEventListener('click', function() {
            dashboardContainer.style.display = 'none';
            renderSystemLogs(); // Ensure logs are updated
            logsContainer.style.display = 'block';
        });
        backToDashboardBtn.addEventListener('click', function() {
            logsContainer.style.display = 'none';
            dashboardContainer.style.display = 'block';
        });

        // Reports Navigation
        reportsMenuItem.addEventListener('click', function() {
            dashboardContainer.style.display = 'none';
            reportContainer.style.display = 'block';
        });
        backToDashboardFromReportBtn.addEventListener('click', function() {
            reportContainer.style.display = 'none';
            dashboardContainer.style.display = 'block';
        });

        // Settings Navigation
        settingsMenuItem.addEventListener('click', function() {
            dashboardContainer.style.display = 'none';
            loadSettings(); // Load settings again when opening to ensure current values
            settingsContainer.style.display = 'block';
        });
        backToDashboardFromSettingsBtn.addEventListener('click', function() {
            settingsContainer.style.display = 'none';
            dashboardContainer.style.display = 'block';
        });

        // View Users Functionality (dynamically creates page if it doesn't exist)
        let userPage = document.getElementById('usersContainer');
        if (!userPage) {
            userPage = document.createElement('div');
            userPage.className = 'logs-container'; // Reusing existing class for consistency
            userPage.id = 'usersContainer';
            userPage.style.display = 'none';
            userPage.innerHTML = `
                <h2 style="display:flex;align-items:center;justify-content:center;gap:10px;">
                    <svg width="32" height="32" viewBox="0 0 54 54" fill="none">
                        <defs>
                            <linearGradient id="usersGrad" x1="0" y1="0" x2="54" y2="54" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#0078d7"/> <stop offset="1" stop-color="#00c6fb"/>
                            </linearGradient>
                        </defs>
                        <circle cx="27" cy="20" r="10" fill="url(#usersGrad)" stroke="#0078d7" stroke-width="2"/>
                        <ellipse cx="27" cy="40" rx="14" ry="8" fill="#e3f0fc" stroke="#0078d7" stroke-width="2"/>
                        <circle cx="19" cy="24" r="4" fill="#00c6fb" opacity="0.7"/> <circle cx="35" cy="24" r="4" fill="#00c6fb" opacity="0.7"/>
                    </svg>
                    <span>View Users</span>
                </h2>
                <ul id="usersList" style="margin-top:18px;"></ul>
                <button class="back-btn" id="backToDashboardFromUsersBtn">Back to Dashboard</button>
            `;
            document.body.appendChild(userPage);
            userPage.querySelector('#backToDashboardFromUsersBtn').addEventListener('click', function() {
                userPage.style.display = 'none';
                dashboardContainer.style.display = 'block';
            });
        }

        const viewUsersMenuItem = dashboardContainer.querySelector('li:nth-child(1)'); // "View Users" menu item
        viewUsersMenuItem.addEventListener('click', function() {
            dashboardContainer.style.display = 'none';
            const usersList = userPage.querySelector('#usersList');
            usersList.innerHTML = ''; // Clear previous list

            let usersData = JSON.parse(localStorage.getItem('users') || '{}');
            const allUsernames = Object.keys(usersData);

            // Sort users: ADMIN first, then alphabetically
            allUsernames.sort((a, b) => {
                if (a === 'ADMIN') return -1;
                if (b === 'ADMIN') return 1;
                return a.localeCompare(b);
            });

            allUsernames.forEach(function(user) {
                let listItemStyle = '';
                let rank = '';
                if (user === 'ADMIN') {
                    rank = 'OWNER';
                    listItemStyle = 'background:linear-gradient(90deg,#0078d7 0%,#00c6fb 100%);color:#fff;font-weight:bold;';
                } else {
                    listItemStyle = `background: var(--list-item-bg); color: var(--text-color);`; // Themed list item
                }

                usersList.innerHTML += `
                    <li style="${listItemStyle}">
                        <span style="margin-right: 8px;">${user}</span>
                        ${rank ? `<span style="background:var(--text-light);color:var(--primary-color);border-radius:4px;padding:2px 8px;font-size:12px;">${rank}</span>` : ''}
                    </li>
                `;
            });
            userPage.style.display = 'block';
        });

        // Chat Menu Item setup
        let chatMenuItem = document.getElementById('chatMenuItem');
        if (!chatMenuItem) { // Add if not already in HTML
            chatMenuItem = document.createElement('li');
            chatMenuItem.id = 'chatMenuItem';
            chatMenuItem.textContent = 'Admin Chat';
            const ul = dashboardContainer.querySelector('ul');
            const systemLogsLi = document.getElementById('systemLogsBtn');
            if (systemLogsLi) {
                ul.insertBefore(chatMenuItem, systemLogsLi); // Insert before logs
            } else {
                ul.appendChild(chatMenuItem); // Fallback
            }
        }
        chatMenuItem.addEventListener('click', function() {
            dashboardContainer.style.display = 'none';
            renderChatMessages();
            chatContainer.style.display = 'block';
        });
        document.getElementById('backToDashboardFromChatBtn').addEventListener('click', function() {
            chatContainer.style.display = 'none';
            dashboardContainer.style.display = 'block';
        });

        // Chat message rendering and form submission
        function renderChatMessages() {
            const chatMessagesDiv = document.getElementById('chatMessages');
            let chatMessages = JSON.parse(localStorage.getItem('adminChat') || '[]');
            chatMessagesDiv.innerHTML = '';
            if (chatMessages.length === 0) {
                chatMessagesDiv.innerHTML = '<div style="color:#888;text-align:center;">No messages yet.</div>';
            } else {
                chatMessages.forEach(function(msg) {
                    const sanitizedText = msg.text.replace(/</g, "<").replace(/>/g, ">");
                    chatMessagesDiv.innerHTML += `
                        <div>
                            <span class="font-weight-bold">${msg.user}</span>
                            <span class="color-muted">${msg.time}</span>
                            <div style="margin-left:8px;">${sanitizedText}</div>
                        </div>
                    `;
                });
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Auto-scroll to bottom
            }
        }
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        if (chatForm && chatInput) {
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                let text = chatInput.value.trim();
                if (!text) return;

                let chatMessages = JSON.parse(localStorage.getItem('adminChat') || '[]');
                const now = new Date();
                const timestamp = now.toISOString().replace('T', ' ').substring(0, 19);
                const sender = currentUser || 'ADMIN';
                chatMessages.push({ user: sender, time: timestamp, text: text });
                localStorage.setItem('adminChat', JSON.stringify(chatMessages));
                chatInput.value = ''; // Clear input
                renderChatMessages();
            });
        }

        // --- Signup Modal and Button Handling ---
        // Ensure signupBtn is correctly handled
        const signupBtn = document.getElementById('signupBtn');
        const signupModal = document.getElementById('signupModal');

        if (!signupModal) { // Create modal only if it doesn't exist
            const modal = document.createElement('div');
            modal.id = 'signupModal';
            modal.style.position = 'fixed'; modal.style.top = 0; modal.style.left = 0;
            modal.style.width = '100vw'; modal.style.height = '100vh';
            modal.style.background = 'rgba(0,0,0,0.3)';
            modal.style.display = 'none'; modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center'; modal.style.zIndex = 10000;
            modal.innerHTML = `
                <div style="background: var(--container-bg); padding: 30px 40px; border-radius: 8px; box-shadow: var(--container-shadow); width: 320px; position: relative; color: var(--text-color);">
                    <h2 style="text-align:center;margin-bottom:18px;">Sign Up</h2>
                    <form id="signupForm">
                        <input type="text" id="signupUsername" placeholder="Username" required style="width:100%;padding:10px;margin-bottom:12px;border:1px solid var(--input-border);border-radius:4px;background-color: var(--input-bg);color: var(--text-color);">
                        <input type="password" id="signupPassword" placeholder="Password" required style="width:100%;padding:10px;margin-bottom:12px;border:1px solid var(--input-border);border-radius:4px;background-color: var(--input-bg);color: var(--text-color);">
                        <button type="submit" style="width:100%;padding:10px;background: var(--button-primary-bg);color: var(--button-primary-text);border:none;border-radius:4px;font-size:16px;cursor:pointer;">Create Account</button>
                    </form>
                    <div id="signupMessage" style="margin-top:10px;text-align:center;color: var(--text-color);"></div>
                    <button id="closeSignupModal" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:18px;cursor:pointer;color: var(--primary-color);">×</button>
                </div>
            `;
            document.body.appendChild(modal);
            // Attach listeners to the newly created modal elements
            modal.querySelector('#closeSignupModal').onclick = () => modal.style.display = 'none';
            modal.querySelector('#signupForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const suName = document.getElementById('signupUsername').value.trim();
                const suPass = document.getElementById('signupPassword').value.trim();
                const msgDiv = document.getElementById('signupMessage');
                if (!suName || !suPass) { msgDiv.textContent = 'Please enter username and password.'; msgDiv.style.color = '#d8000c'; return; }
                let users = JSON.parse(localStorage.getItem('users') || '{}');
                if (users[suName]) { msgDiv.textContent = 'Username already exists.'; msgDiv.style.color = '#d8000c'; return; }
                users[suName] = suPass;
                localStorage.setItem('users', JSON.stringify(users));
                msgDiv.textContent = 'Account created! You can now log in.'; msgDiv.style.color = '#4BB543';
                addSystemLog(`New user ${suName} signed up.`);
                setTimeout(() => modal.style.display = 'none', 1200);
            });
        }

        // If signupBtn was created dynamically (as in original code), ensure its listener is set
        // Assuming 'signupBtn' was intended to be added and present from previous JS execution
        if (!document.getElementById('signupBtn')) { // Add signupBtn if it's missing from initial HTML structure
            const sb = document.createElement('button');
            sb.id = 'signupBtn';
            sb.type = 'button';
            sb.textContent = 'Sign Up';
            sb.style.marginTop = '10px';
            sb.style.background = 'var(--secondary-color)'; // Use theme secondary
            sb.style.fontWeight = 'bold';
            loginForm.appendChild(sb);
        }
        // Add/Re-attach listener for signup button
        document.getElementById('signupBtn').addEventListener('click', function() {
            const modal = document.getElementById('signupModal');
            modal.style.display = 'flex';
            const msgDiv = document.getElementById('signupMessage');
            msgDiv.textContent = ''; msgDiv.style.color = 'var(--text-color)';
            document.getElementById('signupForm').reset();
        });


        // Observer to refine error message formatting (kept for compatibility)
        const messageDivObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (messageDiv.innerHTML.includes('Invalid account name or password.')) {
                    messageDiv.innerHTML = `
                        <div class="error" style="display:flex;align-items:center;justify-content:center;gap:8px;">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <circle cx="10" cy="10" r="10" fill="#d8000c"/>
                                <path d="M6 6l8 8M14 6l-8 8" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            Invalid account name or password!
                        </div>
                    `;
                }
            });
        });
        messageDivObserver.observe(messageDiv, { childList: true, subtree: true });
    });
    </script>
</body>
</html>
